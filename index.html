<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WCA Progress Chart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles if needed, though Tailwind should cover most */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font from Tailwind defaults */
        }
        /* Ensure chart container allows canvas to resize and take full width */
        .chart-container {
            position: relative;
            height: 70vh; /* Adjust height as needed for better vertical space */
            width: 100%;
        }
        /* Style for loading/error messages */
        #message-area {
            min-height: 2rem; /* Reserve space */
        }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-700">WCA Progress Tracker</h1>

        <form id="wca-form" class="bg-white p-6 rounded-lg shadow-md mb-8 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 items-end">
            <div>
                <label for="event" class="block text-sm font-medium text-gray-700 mb-1">Event:</label>
                <select name="event" id="event" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="333">3x3</option>
                    <option value="222">2x2</option>
                    <option value="pyram">Pyraminx</option>
                    <option value="sq1">Square-1</option>
                    <option value="minx">Megaminx</option>
                    <option value="skewb">Skewb</option>
                    <option value="clock">Clock</option>
                    <option value="444">4x4</option>
                    <option value="555">5x5</option>
                    <option value="666">6x6</option>
                    <option value="777">7x7</option>
                    <option value="333bf">3x3 Blind</option>
                    <option value="444bf">4x4 Blind</option>
                    <option value="555bf">5x5 Blind</option>
                    <option value="333mbf">3x3 Multiblind</option>
                    <option value="333fm">3x3 FMC</option>
                    <option value="333oh">3x3 OH</option>
                </select>
            </div>

            <div>
                <label for="wcaid" class="block text-sm font-medium text-gray-700 mb-1">WCA ID:</label>
                <input type="text" id="wcaid" name="wcaid" placeholder="e.g., 2022YAOC02" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div>
                <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Type:</label>
                <select name="type" id="type" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="average">Average</option>
                    <option value="best">Single</option>
                </select>
            </div>

             <div>
                <label for="showdnfs" class="block text-sm font-medium text-gray-700 mb-1">Show DNFs:</label>
                <select name="showdnfs" id="showdnfs" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="True">Yes</option>
                    <option value="False">No</option>
                </select>
            </div>

            <div class="hidden md:block"></div>
            <div class="hidden md:block"></div>

            <div class="sm:col-span-2 md:col-span-4 lg:col-span-2">
                 <button type="button" id="submit" class="w-full mt-4 sm:mt-0 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:opacity-50">
                    Load Chart
                 </button>
            </div>
        </form>

        <div id="message-area" class="text-center mb-4 text-gray-600 font-medium"></div>

        <div class="bg-white p-4 rounded-lg shadow-md">
            <div class="chart-container">
                <canvas id="myChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let progressChart = null; // Use let instead of var
        const submitButton = document.getElementById('submit');
        const wcaIdInput = document.getElementById('wcaid');
        const eventSelect = document.getElementById('event');
        const typeSelect = document.getElementById('type');
        const showDnfsSelect = document.getElementById('showdnfs');
        const messageArea = document.getElementById('message-area');
        const canvas = document.getElementById('myChart');
        const ctx = canvas.getContext('2d');

        // --- Helper Functions ---

        // Formats seconds into MM:SS.ss or SS.ss format
        function formatTime(value, event) {
            if (value <= 0) return "DNF"; // Handle DNF values explicitly
            if (event === "333fm" || event === "333mbf") {
                // FMC is moves, MBLD is points (decoded later) - return as is for now
                // MBLD specific formatting might be needed if API provides raw data
                if (event === "333mbf") {
                    // Example MBLD decode: 99 - (difference * 100 + time) / 10000000
                    // Assuming 'value' here is the direct result number like 197052103
                    // This requires understanding the exact encoding used in the API source
                    // For simplicity, just display the raw value or a placeholder
                    // return `MBLD: ${value}`; // Placeholder
                    let difference = Math.floor(value / 100000000); // DD
                    let points = 99 - difference;
                    let timeSeconds = (value % 10000000) / 100; // TTTTT.ss
                    let missed = (value % 100000000 - value % 10000000) / 10000000; // MM
                    let solved = points + missed;
                    return `<span class="math-inline"><span class="math-inline">\\\{solved\\\}/</span\></span>\{solved+missed\} ${formatTime(timeSeconds, 'time')}`; // Format time part
                }
                return value; // Return FMC moves as is
            }

            // Standard time formatting
            const seconds = parseFloat(value);
            if (isNaN(seconds)) return "N/A";

            if (seconds >= 60) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = (seconds % 60).toFixed(2);
                return `<span class="math-inline"><span class="math-inline">\\\{minutes\\\}\\\:</span\></span>\{remainingSeconds < 10 ? '0' : ''\}${remainingSeconds}`;
            } else {
                return seconds.toFixed(2);
            }
        }

        // --- Main Chart Loading Function ---
        function loadChart() {
            const wcaId = wcaIdInput.value.trim();
            const event = eventSelect.value;
            let type = typeSelect.value; // Use let as it might change
            const showdnfs = showDnfsSelect.value;

            if (!wcaId) {
                messageArea.textContent = 'Please enter a WCA ID.';
                messageArea.className = 'text-center mb-4 text-red-600 font-medium';
                return;
            }

            // Handle MBLD: always 'best', disable type selection visually if desired
            if (event === "333mbf") {
                type = "best";
                typeSelect.value = "best";
                // Optionally disable the type dropdown when MBLD is selected
                // typeSelect.disabled = true;
            } else {
                // Re-enable if previously disabled
                // typeSelect.disabled = false;
            }


            // Clear previous chart and messages
            if (progressChart) {
                progressChart.destroy();
                progressChart = null;
            }
            messageArea.textContent = 'Loading data...';
            messageArea.className = 'text-center mb-4 text-blue-600 font-medium';
            submitButton.disabled = true; // Disable button during load

            // --- Data Fetching ---
            const apiUrl = `https://raw.githubusercontent.com/robiningelbrecht/wca-rest-api/master/api/persons/${wcaId.toUpperCase()}.json`;

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("API Data:", data); // Log received data
                    if (!data || !data.results) {
                         throw new Error("Invalid data structure received from API.");
                    }
                    processAndDrawChart(data, wcaId, event, type, showdnfs);
                    messageArea.textContent = ''; // Clear loading message
                })
                .catch(error => {
                    console.error('Error fetching or processing WCA data:', error);
                    messageArea.textContent = `Error: ${error.message}. Could not load data for ${wcaId}. Check the ID or API source.`;
                    messageArea.className = 'text-center mb-4 text-red-600 font-medium';
                    // Clear canvas if error occurs after chart init attempt
                    if (progressChart) {
                        progressChart.destroy();
                        progressChart = null;
                    } else {
                        // Ensure canvas is blank if it never got drawn
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }
                })
                .finally(() => {
                    submitButton.disabled = false; // Re-enable button
                });
        }

        // --- Data Processing and Chart Drawing ---
        function processAndDrawChart(data, wcaId, event, type, showdnfs) {
            const solveData = []; // Store { x: label, y: value } for chart

            // Iterate through competitions (keys of results object)
            const compKeys = Object.keys(data.results);

            for (const compKey of compKeys) {
                const compResult = data.results[compKey];
                // Check if the event exists for this competition
                if (compResult && compResult[event] && Array.isArray(compResult[event])) {
                    compResult[event].forEach(roundResult => {
                        // Check if the result type (best/average) exists and is valid
                        if (roundResult && roundResult.hasOwnProperty(type)) {
                            const value = roundResult[type];

                            // Filter DNFs based on selection
                            // WCA API uses 0 or negative for DNF/DNS
                            if (showdnfs === "False" && value <= 0) {
                                return; // Skip this DNF result
                            }

                            let yValue;
                            // MBLD and FMC have different value interpretations
                            if (event === "333mbf") {
                                yValue = value; // Keep raw MBLD value for now, format in tooltip
                            } else if (event === "333fm") {
                                yValue = value; // FMC is number of moves
                            } else {
                                yValue = value / 100; // Convert centiseconds to seconds for time events
                            }

                            // Create label (Competition Name + Round)
                            const label = `${compKey} ${roundResult.round || ''}`.trim();

                            solveData.push({ x: label, y: yValue });
                        }
                    });
                }
            }

            if (solveData.length === 0) {
                messageArea.textContent = `No results found for <span class="math-inline">\{wcaId\} in <span class\="math\-inline"\></span>\{event\.toUpperCase\(\)\}\) \(</span>$\{type\}).`;
                messageArea.className = 'text-center mb-4 text-orange-600 font-medium';
                ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas explicitly
                return; // Stop if no data to plot
            }

            // Reverse the array to make it chronological
            solveData.reverse();

            // --- Draw Chart ---
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    // Use the processed solveData directly
                    datasets: [{
                        label: `<span class="math-inline">\{wcaId\} \- <span class\="math\-inline"\></span>\{event\.toUpperCase\(\)\}\) \(</span>$\{type\})`,
                        data: solveData, // Data points {x: label, y: value}
                        borderColor: 'rgb(59, 130, 246)', // Blue color
                        backgroundColor: 'rgba(59, 130, 246, 0.1)', // Light blue fill
                        tension: 0.1, // Slight curve
                        borderWidth: 2,
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: true, // Add fill under the line
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Important for custom container size
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Competition & Round',
                                font: { size: 14 }
                            },
                            ticks: {
                                // Auto-skip ticks if too many labels
                                autoSkip: true,
                                maxTicksLimit: 15, // Adjust as needed
                                maxRotation: 45, // Rotate labels if they overlap
                                minRotation: 0
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: (event === '333fm' || event === '333mbf') ? 'Result' : 'Time (seconds)', // Dynamic Y-axis label
                                font: { size: 14 }
                            },
                            ticks: {
                                // Callback to format Y-axis ticks (times)
                                callback: function(value, index, values) {
                                    // Don't format FMC/MBLD axis, but format time axes
                                    if (event === '333fm' || event === '333mbf') {
                                        if (event === '333mbf' && value > 1000) { // Basic check for raw MBLD value
                                            return formatTime(value, event); // Attempt MBLD format
                                        }
                                        return value; // Return raw number for FMC/MBLD
                                    }
                                    // Only format if it's not a DNF placeholder (like 0 or negative)
                                    // Chart.js might pass calculated ticks, ensure they are valid numbers
                                    if (typeof value === 'number' && value > 0) {
                                        return formatTime(value, event);
                                    }
                                    // Handle 0 or potential negative axis values if chart auto-scales below 0
                                    return value <= 0 ? '0.00' : formatTime(value, event);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                // Format the value displayed in the tooltip
                                label: function
function(context) {
                                                              let label = context.dataset.label || '';
                                                              if (label) {
                                                                  label += ': ';
                                                              }
                                                              const rawValue = context.raw.y;
                                                              // Use the formatTime function for tooltip display
                                                              label += formatTime(rawValue, event);
                                                              return label;
                                                        }
                                                   }
                                                },
                                                legend: {
                                                    position: 'top',
                                                },
                                                title: { // Chart
                                                    display: true,
                                                    text: `Progress for ${wcaId} - <span class="math-inline">\{event\.toUpperCase\(\)\} \(</span>{type})`,
                                                    font: { size: 16 }
                                                }
                                           }
                                    }
                            });
                }

                // --- Event Listeners ---
                submitButton.addEventListener('click', loadChart);

                // Optional: Load chart on Enter key press in WCA ID input
                wcaIdInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Prevent form submission if it were a real form
                        loadChart();
                    }
                });

                // Optional: Automatically adjust type for MBLD when event changes
                eventSelect.addEventListener('change', () => {
                    if (eventSelect.value === '333mbf') {
                        typeSelect.value = 'best';
                        // typeSelect.disabled = true; // Optional UI cue
                    } else {
                        // typeSelect.disabled = false; // Re-enable if needed
                    }
                });

            </script>

        </body>
        </html>
        
        
        
        
        
        
        
     
